<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin — Premium MLM Demo</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header class="header">
  <div class="brand">PREMIUM MLM SCRIPT — Admin</div>
  <nav>
    <a href="index.html">Home</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="#" onclick="App.Auth.logout();return false" style="color:#ffb3b3">Logout</a>
  </nav>
</header>

<main class="container">
  <div class="card">
    <h2>Admin Console</h2>
    <div class="small" id="adminSummary"></div>
    <div style="margin-top:10px">
      <button class="btn" onclick="App.Admin.exportUsersCSV()">Export Users CSV</button>
      <button class="btn ghost" onclick="renderAll()">Refresh</button>
    </div>
  </div>

  <div class="card">
    <h3>Pending Withdraw Requests</h3>
    <div id="withdrawList" class="small"></div>
  </div>

  <div class="card">
    <h3>KYC Requests</h3>
    <div id="kycList" class="small"></div>
  </div>

  <div class="card">
    <h3>Users (quick)</h3>
    <table class="table" id="usersTable"><thead><tr><th>Username</th><th>Name</th><th>Balance</th><th>Bonus</th><th>Ref</th></tr></thead><tbody></tbody></table>
  </div>

</main>

<script src="app.js"></script>
<script>
if(!App.Auth.isLogged() || !App.Auth.current().is_admin){ alert('Admin only'); location.href='login.html'; }

function renderAll(){
  const s = App.Admin.summary();
  adminSummary.innerText = `Total Users: ${s.totalUsers} — Total Platform Balance: $${s.totalBalance.toFixed(2)} — Pending Withdraw: $${s.totalPendingWithdraw.toFixed(2)}`;

  // withdraws
  const wlist = App.Admin.withdraws();
  withdrawList.innerHTML = '';
  if(wlist.length===0) withdrawList.innerText = 'No withdraws';
  wlist.forEach(w=>{
    const div = document.createElement('div');
    div.style.marginBottom='8px';
    div.innerHTML = `<b>${w.username}</b> — $${w.amount} — ${w.status}
      ${w.status==='pending' ? `<button class="btn" onclick="approve('${w.id}')">Approve</button> <button class="btn ghost" onclick="reject('${w.id}')">Reject</button>` : ''}`;
    withdrawList.appendChild(div);
  });

  // kyc
  const k = App.Admin.kycRequests();
  kycList.innerHTML = '';
  if(k.length===0) kycList.innerText = 'No KYC requests';
  k.forEach(r=>{
    const d = document.createElement('div'); d.style.marginBottom='12px';
    d.innerHTML = `<div><b>${r.username}</b> — ${r.status}</div>
      <div style="margin-top:6px"><img src="${r.fileBase64}" style="max-width:250px;border:1px solid #ccc"></div>
      <div style="margin-top:6px">${r.status==='pending' ? `<button class="btn" onclick="approveKYC('${r.username}')">Approve</button> <button class="btn ghost" onclick="rejectKYC('${r.username}')">Reject</button>` : ''}</div>`;
    kycList.appendChild(d);
  });

  // users
  const users = App.Admin.users();
  const tbody = document.querySelector('#usersTable tbody'); tbody.innerHTML = '';
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.username}</td><td>${u.name}</td><td>$${Number(u.balance||0).toFixed(2)}</td><td>$${Number(u.bonus||0).toFixed(2)}</td><td>${u.ref||''}</td>`;
    tbody.appendChild(tr);
  });
}

function approve(id){
  App.Withdraws.approve(id, App.Auth.current().username);
  alert('Approved');
  renderAll();
}
function reject(id){
  App.Withdraws.reject(id, App.Auth.current().username);
  alert('Rejected');
  renderAll();
}
function approveKYC(username){
  App.KYC.approve(username, App.Auth.current().username);
  alert('KYC approved for ' + username);
  renderAll();
}
function rejectKYC(username){
  const note = prompt('Reason for rejection (optional)');
  App.KYC.reject(username, App.Auth.current().username, note||'');
  alert('KYC rejected for ' + username);
  renderAll();
}

renderAll();
</script>
</body>
</html>
