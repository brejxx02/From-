<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard — Premium MLM Demo</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header class="header">
  <div class="brand">PREMIUM MLM SCRIPT</div>
  <nav>
    <a href="index.html">Home</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="admin.html">Admin</a>
    <a href="#" onclick="App.Auth.logout();return false" style="color:#ffb3b3">Logout</a>
  </nav>
</header>

<main class="container">
  <div class="card">
    <h2 id="u_name"></h2>
    <div class="small">Wallet: $<b id="u_balance">0.00</b> — Bonus: $<b id="u_bonus">0.00</b></div>
    <div style="margin-top:12px">
      <button class="btn" onclick="App.Users.simulateJoinUnder(App.Auth.current().username)">Simulate New Signup under me</button>
      <button class="btn ghost" onclick="App.Users.exportMyData()" style="margin-left:8px">Export My Data</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h3>Deposit / Payment (Simulated)</h3>
        <input id="depositAmt" class="input" placeholder="Amount to deposit (min 10)">
        <button class="btn" onclick="createAndPay()">Create Order & Pay</button>
        <div id="orderRes" class="small" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <h3>Buy Plan</h3>
        <select id="planBuy" class="input"></select>
        <button class="btn" onclick="buyPlan()">Buy Plan</button>
        <div id="planMsg" class="small" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <h3>ROI (Manual Credit for Demo)</h3>
        <button class="btn" onclick="creditROI()">Credit ROI for my plans</button>
        <div class="small" style="margin-top:8px">Use this to simulate ROI payout to your wallet.</div>
      </div>

      <div class="card">
        <h3>Withdraw</h3>
        <input id="wdAmt" class="input" placeholder="Amount to withdraw">
        <button class="btn" onclick="requestWithdraw()">Request Withdraw</button>
        <div id="wdMsg" class="small" style="margin-top:8px"></div>
      </div>

    </div>

    <aside>
      <div class="card">
        <h3>Profile & KYC</h3>
        <div id="kycArea" class="small"></div>
        <input id="kycFile" type="file" class="input" accept="image/*">
        <button class="btn" onclick="uploadKYC()">Upload KYC</button>
      </div>

      <div class="card">
        <h3>Your Referral Link</h3>
        <div class="code" id="r_link"></div>
        <button class="btn ghost" onclick="copyRef()">Copy Link</button>
      </div>

      <div class="card">
        <h3>Team Tree</h3>
        <div id="treeArea" style="max-height:380px;overflow:auto"></div>
      </div>
    </aside>
  </div>

  <div class="card">
    <h3>Transactions</h3>
    <table class="table" id="txTable"><thead><tr><th>Type</th><th>Amount</th><th>Info</th><th>Time</th></tr></thead><tbody></tbody></table>
  </div>

</main>

<script src="app.js"></script>
<script>
// page init
(function initDashboard(){
  if(!App.Auth.isLogged()){ alert('Please login'); location.href='login.html'; }
  const me = App.Auth.current();
  document.getElementById('u_name').innerText = `Hello, ${me.name} (${me.username})`;
  loadUserDetails();
  // populate plans buy dropdown
  const sel = document.getElementById('planBuy');
  App.DB.settings.plans.forEach(p=>{
    const opt = document.createElement('option'); opt.value=p.id; opt.textContent = `${p.name} — $${p.price} — ROI ${p.roi_percent}%`;
    sel.appendChild(opt);
  });
})();
function loadUserDetails(){
  const me = App.Auth.current(); const u = App.Users.get(me.username);
  document.getElementById('u_balance').innerText = Number(u.balance||0).toFixed(2);
  document.getElementById('u_bonus').innerText = Number(u.bonus||0).toFixed(2);
  document.getElementById('r_link').innerText = location.origin + '/register.html?ref=' + me.username;
  // KYC area
  const k = u.kyc;
  const ka = document.getElementById('kycArea');
  if(k && k.status === 'approved') ka.innerHTML = `<div class="small">KYC approved</div>`;
  else if(k && k.status === 'rejected') ka.innerHTML = `<div class="small">KYC rejected</div>`;
  else ka.innerHTML = `<div class="small">No KYC uploaded</div>`;

  // transactions
  const txs = App.Users.getTransactions(me.username);
  const tbody = document.querySelector('#txTable tbody'); tbody.innerHTML='';
  txs.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.type}</td><td>$${Number(t.amount).toFixed(2)}</td><td>${t.info||''}</td><td>${new Date(t.time).toLocaleString()}</td>`;
    tbody.appendChild(tr);
  });

  // build tree
  renderTree(me.username);

}

function createAndPay(){
  const amt = Number(document.getElementById('depositAmt').value || 0);
  if(amt < 1){ orderRes.innerText = 'Enter valid amount'; return; }
  const me = App.Auth.current();
  const order = App.Payments.createOrder(me.username, amt);
  // simulate immediate success (for demo) — in real world you'd redirect to gateway
  const res = App.Payments.simulateGatewaySuccess(order.id);
  if(res.ok){ orderRes.innerText = `Paid $${amt} — credited to wallet`; loadUserDetails(); } else { orderRes.innerText = res.error || 'Payment failed'; }
}

function buyPlan(){
  const planId = document.getElementById('planBuy').value;
  const me = App.Auth.current();
  const out = App.Users.purchasePlan(me.username, planId);
  document.getElementById('planMsg').innerText = out.ok ? 'Plan purchased' : (out.error||'Error');
  loadUserDetails();
}

function creditROI(){
  const me = App.Auth.current();
  const out = App.Users.creditROIForUser(me.username);
  alert('ROI credited: $' + (out.credited||0));
  loadUserDetails();
}

function requestWithdraw(){
  const amt = Number(document.getElementById('wdAmt').value || 0);
  if(amt <= 0) { wdMsg.innerText = 'Enter amount'; return; }
  const me = App.Auth.current();
  const out = App.Withdraws.request(me.username, amt);
  wdMsg.innerText = out.ok ? 'Withdraw requested' : (out.error || 'Failed');
  loadUserDetails();
}

function uploadKYC(){
  const f = document.getElementById('kycFile').files[0];
  if(!f){ alert('Choose file'); return; }
  const r = new FileReader();
  r.onload = ()=>{
    const base64 = r.result;
    const me = App.Auth.current();
    App.KYC.submit(me.username, base64);
    alert('KYC uploaded (pending admin approval)');
    loadUserDetails();
  };
  r.readAsDataURL(f);
}

function copyRef(){
  navigator.clipboard.writeText(document.getElementById('r_link').innerText);
  alert('Copied');
}

// team tree rendering
function renderTree(rootUsername){
  const treeArea = document.getElementById('treeArea');
  const root = App.util.buildTree(rootUsername);
  treeArea.innerHTML = '';
  if(!root) { treeArea.innerText = 'No tree'; return; }
  function makeNode(node){
    const el = document.createElement('div');
    el.style.marginLeft = '8px';
    const row = document.createElement('div');
    row.innerHTML = `<b>${node.username}</b> <span class="small">(${node.name})</span> <span style="margin-left:8px" class="small">[${(node.children||[]).length} direct]</span>`;
    el.appendChild(row);
    if(node.children && node.children.length){
      const btn = document.createElement('button');
      btn.textContent = 'Toggle';
      btn.className = 'btn ghost';
      btn.style.marginTop='6px';
      const childContainer = document.createElement('div');
      childContainer.style.display='none';
      node.children.forEach(c=>{
        childContainer.appendChild(makeNode(c));
      });
      btn.onclick = ()=> childContainer.style.display = childContainer.style.display === 'none' ? 'block' : 'none';
      el.appendChild(btn);
      el.appendChild(childContainer);
    }
    return el;
  }
  treeArea.appendChild(makeNode(root));
}

// refresh helper
window.onload = loadUserDetails;
window._refreshDashboard = loadUserDetails;
</script>
</body>
</html>
